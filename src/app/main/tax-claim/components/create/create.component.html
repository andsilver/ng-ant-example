<nz-modal [(nzVisible)]="isVisible" nzTitle="Create Tax Claim" (nzOnCancel)="closeModal()" (nzOnOk)="nextStep()">
  <div style="padding: 24px">
    <nz-steps [nzCurrent]="step">
      <nz-step></nz-step>
      <nz-step></nz-step>
      <nz-step></nz-step>
    </nz-steps>
    <form *ngIf="form" nz-form [formGroup]="form" style="margin-top: 24px">
      <div *ngIf="step == 0" nz-row nzType="flex" nzGutter="24">
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label>Select Tax Register</nz-form-label>
            <nz-form-control>
              <app-autocomplete formControlName="register" [data]="taxRegisters" valueField="code" labelField="name"></app-autocomplete>
              <nz-form-explain *ngIf="register.dirty && register.errors">Please select the tax register!</nz-form-explain>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div *ngIf="step == 2">
        <ng-container *ngIf="dynamicForm">
          <ng-container *ngTemplateOutlet="dynamic; context: {$implicit: dynamicForm, fields: fields}"></ng-container>
        </ng-container>
      </div>
    </form>
  </div>
</nz-modal>

<ng-template #dynamic let-form let-fields="fields">
  <form nz-form [formGroup]="form">
    <div nz-row nzGutter="16">
      <div nz-col nzSpan="12" *ngFor="let field of fields">
        <nz-form-item>
          <label style="margin-right: 8px" nz-checkbox *ngIf="field.value.type != 'logical' && field.optional" [formControlName]="'option_' + field.name" (ngModelChange)="toggleDisable(field, $event)"></label>
          <nz-form-label *ngIf="field.value.type != 'logical'" [nzRequired]="!field.optional">{{field.label}}</nz-form-label>
          <nz-form-control>
            <ng-container *ngIf="field.value.type == 'enumeration'">
              <nz-select [formControlName]="field.name">
                <nz-option *ngFor="let choice of field.value.choices" [nzValue]="choice" [nzLabel]="choice"></nz-option>
              </nz-select>
            </ng-container>

            <ng-container *ngIf="field.value.type == 'number'">
              <nz-input-number [formControlName]="field.name" [nzPrecision]="field.value.decimals"></nz-input-number>
            </ng-container>

            <ng-container *ngIf="field.value.type == 'logical'">
              <label nz-checkbox [formControlName]="field.name">{{field.label}}</label>
            </ng-container>

            <ng-container *ngIf="field.value.type == 'date'">
              <nz-date-picker [formControlName]="field.name"></nz-date-picker>
            </ng-container>

            <ng-container *ngIf="field.value.type == 'text'">
              <input nz-input [formControlName]="field.name">
            </ng-container>

            <div style="margin-left: 12px" *ngIf="field.value.type == 'composite'">
              <ng-container *ngTemplateOutlet="dynamic; context: {$implicit: form.get(field.name), fields: field.value.fields}">
              </ng-container>
            </div>

            <div style="margin-left: 12px" *ngIf="field.value.type == 'list'">
              <form [formArrayName]="field.name">
                <nz-form-item>
                  <nz-form-control *ngFor="let item of formArrayControls(form.get(field.name)); let i=index;">
                    <input nz-input type="text" [formControlName]="i" class="removal-item">
                    <i nz-icon type="minus-circle-o" class="dynamic-delete-button" (click)="removeField(form.get(field.name), i)"></i>
                    <nz-form-explain *ngIf="item.dirty && item.errors">The field is required!</nz-form-explain>
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <button nz-button nzType="dashed" style="width: 80%" (click)="addField(form.get(field.name))"><i nz-icon type="plus"></i> New</button>
                </nz-form-item>
              </form>
            </div>

            <nz-form-explain *ngIf="form.get(field.name).dirty && form.get(field.name).errors">Please input the {{field.label}}!</nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
  </form>
</ng-template>
